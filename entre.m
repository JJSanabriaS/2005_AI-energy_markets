
%ear all 
%clc
% carga de las variables para la red
tred1=[tred fentre fapre nc 0 0 0 0 0 0 0];
% carga de las variables de las capas ocultas
fc=[tc1 tc2 tc3 tc4 tc5 fc1 fc2 fc3 fc4 fc5 p];
periodo=7; nsal=1;
% parametros para la RNA
parametrosred=[tred1;fc];

% carga del archivo de fiestas
festivos=dlmread('festivos.txt',' ',0,0);
%pesos=dlmread('pesos.txt',' ',0,0);
%close all;
switch parametrosred(1,2)   
case 1, fentrena='traingd';
case 2, fentrena='trainlm';
case 3, fentrena='trainrp';
case 4, fentrena='traingdm';
end
	if parametrosred(1,3)==1
   	faprendiza='learngd';
   else 
      faprendiza='learngdm';
	end
   numerocapas=(parametrosred(1,4));
   clear tamanocapa funcion
for a=1:1:numerocapas
   tamanocapa(a)=parametrosred(2,a);
   funcion(a)=parametrosred(2,5+a);
end
%----------------------------------------------------------------------------------
% Carga la irregularidad de los datos de entrenamiento
pr2=dlmread('irrtot.txt',',');
pr=dlmread('mmaxirent.txt',',');
%--------------------------------------------------------------------
% manejo de la irregularidad de los datos objetivo
t2=dlmread('irregula1.txt',',');
%---------------------------------------------------------------------
% Toma de los datos de entreamiento y preparación
[p,q]=size(pr2);
ttrain=floor(0.8*p);
for i=1:1:ttrain
   seriet(i,:)=pr2(i,:);  % 80% de los datos usados para el entrenam
   pesosseriet(i,:)=pesos1(i,:);
   tenden1(i,:)=tenden(i,:);
end
k=1;
clear seriev pesosseriev;
for i=ttrain+1:1:p
   seriev(k,:)=pr2(i,:); % resto de los datos de entrenam
   pesosseriev(k,:)=pesos1(i,:);
   tenden2(k,:)=tenden(i,:);
   k=k+1;
end
% normalizacion de la entrada a la RNA
[serieen,minserien,maxserien,serieob,minserieob,maxserieob]=premnmx(seriet,seriev);
seriet1=[serieen pesosseriet]; % se va a entrenar con todos los datos
seriev1=[serieob pesosseriev]; % 20% de los datos del entrenamiento
tsal=size(seriev);
nsal=tsal(1);
% Caracteristicas de las redes neuronales
if parametrosred(1) ==1 
    tipored='newelm';
    red=newelm(minmax(seriet1),[tamanocapa nsal]);
elseif parametrosred(1)==2
   tipored='newff';
   red=newff(minmax(seriet1),[tamanocapa nsal]);
elseif parametrosred(1)==3
   tipored='newcf';
   red=newcf(minmax(seriet1),[tamanocapa nsal]);
end
% carga de la función de entrnamiento
red.trainFcn=fentrena; 

% icialización de las capas
red.initFcn='initlay';     
% se asignan pesos a la capas de acuerdo con ek criterio de Nguyen-Widrow
for i=1:1:numerocapas     										  
red.layers{i}.size=tamanocapa(i); 
red.layers{i}.initFcn='initnw';
  if funcion(i)==1 red.layers{i}.transferFcn='logsig';   red1.layers{i}.transferFcn='logsig';
    elseif funcion(i)==2 red.layers{i}.transferFcn='tansig'; red1.layers{i}.transferFcn='tansig';
  		   else red.layers{i}.transferFcn='purelin'; 		red1.layers{i}.transferFcn='purelin';			  
        end 																	 
     end 		
     figure
red.trainParam.epochs = epocas;  				
red.trainParam.goal = goal;  				
red.trainParam.lr=lr; 
red.performfcn='msereg'; % regularización de la red

minmax(seriet);

% inicialización de la red
red=init(red);
[red,tr1]=train(red,seriet1,seriev1); % datos completos +pesos
%---------------------------------------------------------------------%

% Revisión del comportamiento luego del entrenamiento 
epoca=tr1.epoch;
y=sim(red,serieen);
li=min(serie);
y=postmnmx(y,(minserieob),max(maxserieob));
[tendena,mint,maxt]=premnmx(tenden1);
y=mean(y);
t=sim(red,tendena);
figure
tam=size(t2);  
%pra=(t2(tam(1),:));
pra=mean(seriev); hold;

plot((pra(:,1:1:tam(2))),'r');
plot(transpose(y(:,1:1:tam(2))),'g');

title('Irregularidades(real(rojo),calculadas por RNA(verde))');
t=postmnmx(mean(t),(min(mint)),max(maxt));


figure
subplot(2,1,1)
plot(pra(:,1:1:tam(2)).*ciclo.*t(:,1:1:tam(2)),'r')
hold;
plot(y(:,1:1:tam(2)).*ciclo.*t(:,1:1:tam(2)),'g')
text(14.5,li+10,vect(1,:));
text(34.5,li+10,vect(2,:)); 
text(64.5,li+10,vect(3,:)); text(84.5,li+10,vect(4,:)); 
text(104.5,li+10,vect(5,:));text(130.5,li+10,vect(6,:));
text(154.5,li+10,vect(7,:));
%plot(y1.*ciclo.*t1(:,1:1:tam(2)),'y')
[pra;y(:,1:1:tam(2))];
dlmwrite('resultados.txt',ans,',');
title('Recuperación de la señal (real(rojo),calculadas con pesos(verde))')
ylabel(ulabel);
pra=pra(:,1:1:tam(2)).*ciclo.*t(:,1:1:tam(2));
y=y(:,1:1:tam(2)).*ciclo.*t(:,1:1:tam(2));
e=abs(pra-y(:,1:1:tam(2)));
e1=abs(pra-y(:,1:1:tam(2)))./pra;
larg=tam(2);
mad=(sum(e)/larg); 
emc=sqrt(((sum((e).^2))/larg));  
mape=(sum(e1)/larg)*100;
dlmwrite('resultadosy.txt',ans,',');
set(gcf,'menubar','none');
set(gcf,'numbertitle','off');
set(gcf,'name','Recuperación de la serie entrenamiento');
set(gcf,'color',[1 1 1]);
set(gcf,'position',[0 25 650 420]);
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 138.25 297 15.75], ...
   'String','Tipo de red', ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 138.25 297 15.75], ...
   'String',tipored, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 123.25 297 15.75], ...
   'String','Función de aprendizaje', ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 123.25 297 15.75], ...
   'String',faprendiza, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 108.25 297 15.75], ...
   'String','Función de entrenamiento', ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 108.25 297 15.75], ...
   'String',fentrena, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 93.25 297 15.75], ...
   'String','Numero de capas (oculta)', ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 93.25 297 15.75], ...
   'String',nc, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');

h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 78.25 297 15.75], ...
   'String','Desv. abs. de la media (MAD)' , ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 78.25 297 15.75], ...
   'String',mad, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
   'Tag','StaticText1');

h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[373 78.25 30 15.75], ...
   'String',ulabel, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
   'Tag','StaticText1');

h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 63.25 297 15.75], ...
   'String','Raíz del error medio cuadrado (MSE)', ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
	'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 63.25 297 15.75], ...
   'String',emc, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
   'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[373 63.25 30 15.75], ...
   'String',ulabel, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
   'Tag','StaticText1');

h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[63 48.25 297 15.75], ...
   'String','Porcentaje de error medio abs. (MAPE)', ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
   'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
	'ListboxTop',0, ...
	'Position',[313 48.25 297 15.75], ...
   'String',mape, ...
	'BackgroundColor',[1 1 1],...   
	'Style','text', ...
   'Tag','StaticText1');
h1 = uicontrol(gcf, ...
	'Units','points', ...
	'BackgroundColor',[0.752941176470588 0.752941176470588 0.752941176470588], ...
	'fontname','MS Sans Serif',...
   'fontsize',10,...
	'HorizontalAlignment','left', ...
   'ListboxTop',0, ...
   'BackgroundColor',[1 1 1],... 
	'Position',[373 48.25 30 15.75], ...
   'String','%', ...
	'Style','text', ...
   'Tag','StaticText1');
presresul
